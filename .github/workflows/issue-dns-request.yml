name: Validate DNS Request Payload

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  issues: read
  contents: read

jobs:
  preview-payload:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.issue.state == 'open' && github.event.comment.body == '/create-PR-DNS')
    runs-on: ubuntu-latest

    steps:
      - name: Parse issue form -> build JSON payload file
        id: parse
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import json, os, re, sys

          event_path = os.environ["GITHUB_EVENT_PATH"]
          with open(event_path, "r") as f:
            event = json.load(f)

          body = event.get("issue", {}).get("body", "")

          def extract_section(name: str) -> str:
            pattern = re.compile(rf"^###\s+{re.escape(name)}\s*$", re.MULTILINE)
            match = pattern.search(body)
            if not match:
              return ""
            start = match.end()
            next_heading = re.search(r"^###\s+", body[start:], re.MULTILINE)
            end = start + next_heading.start() if next_heading else len(body)
            return body[start:end].strip()

          request_id = extract_section("Request Number")
          environment = extract_section("Environment Name")
          mappings_raw = extract_section("Namespace and DNS Names")

          def parse_namespace_dns_mappings(text: str):
            requests = []
            current_ns = None
            current_dns = []

            lines = [ln.rstrip() for ln in text.splitlines()]
            for ln in lines:
              if not ln.strip():
                continue

              m = re.match(r"^\s*namespace\s*:\s*(.+?)\s*$", ln, re.IGNORECASE)
              if m:
                if current_ns:
                  if not current_dns:
                    raise ValueError(f"Namespace '{current_ns}' has no DNS entries.")
                  requests.append({"namespace": current_ns, "dns_names": current_dns})
                current_ns = m.group(1).strip()
                current_dns = []
                continue

              if re.match(r"^\s*dns\s*:\s*$", ln, re.IGNORECASE):
                continue

              m = re.match(r"^\s*-\s*(.+?)\s*$", ln)
              if m:
                if not current_ns:
                  raise ValueError("Found DNS entry before any namespace.")
                current_dns.append(m.group(1).strip())
                continue

              raise ValueError(f"Unrecognized line: '{ln}'")

            if current_ns:
              if not current_dns:
                raise ValueError(f"Namespace '{current_ns}' has no DNS entries.")
              requests.append({"namespace": current_ns, "dns_names": current_dns})

            return requests

          missing = []
          if not request_id: missing.append("Request Number")
          if not environment: missing.append("Environment Name")
          if not mappings_raw: missing.append("Namespace and DNS Names")

          if missing:
            print(f"ERROR: Missing required fields: {', '.join(missing)}")
            sys.exit(1)

          try:
            requests = parse_namespace_dns_mappings(mappings_raw)
          except Exception as e:
            print(f"ERROR: Failed to parse 'Namespace and DNS Names': {e}")
            sys.exit(1)

          payload = {
            "repo_name": event.get("repository", {}).get("full_name"),
            "request_id": request_id,
            "environment": environment,
            "requests": requests,
          }

          # write both raw + pretty
          with open("request_payload.json", "w") as f:
            json.dump(payload, f)
          with open("request_payload.pretty.json", "w") as f:
            json.dump(payload, f, indent=2)

          print("âœ… Generated payload files:")
          print(" - request_payload.json (raw)")
          print(" - request_payload.pretty.json (pretty)")

          # also expose as outputs (strings)
          payload_json = json.dumps(payload)
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
            out.write(f"request_id={request_id}\n")
            out.write(f"environment={environment}\n")
            out.write("request_payload<<EOF\n")
            out.write(payload_json + "\n")
            out.write("EOF\n")
          PY

      - name: Print payload in logs (pretty)
        shell: bash
        run: |
          echo "================ PRETTY JSON ================"
          cat request_payload.pretty.json
          echo "============================================"

      - name: Print payload in logs (raw one-line)
        shell: bash
        run: |
          echo "================ RAW JSON ==================="
          cat request_payload.json
          echo
          echo "============================================"

      - name: Upload payload files as artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: request-payload
          path: |
            request_payload.json
            request_payload.pretty.json

      - name: Show outputs (for validation)
        shell: bash
        run: |
          echo "request_id: ${{ steps.parse.outputs.request_id }}"
          echo "environment: ${{ steps.parse.outputs.environment }}"
          echo "request_payload (from output, one-line):"
          echo '${{ steps.parse.outputs.request_payload }}'

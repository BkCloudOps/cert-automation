- name: Parse issue form
  id: parse
  run: |
    python - <<'PY'
    import json
    import os
    import re
    import sys

    event_path = os.environ["GITHUB_EVENT_PATH"]
    with open(event_path, "r") as file:
      event = json.load(file)

    body = event.get("issue", {}).get("body", "")

    def extract_section(name: str) -> str:
      pattern = re.compile(rf"^###\s+{re.escape(name)}\s*$", re.MULTILINE)
      match = pattern.search(body)
      if not match:
        return ""
      start = match.end()
      next_heading = re.search(r"^###\s+", body[start:], re.MULTILINE)
      end = start + next_heading.start() if next_heading else len(body)
      return body[start:end].strip()

    request_id = extract_section("Request Number")
    environment = extract_section("Environment Name")

    # NEW: combined textarea heading from your issue form
    mappings_raw = extract_section("Namespace and DNS Names")

    def parse_namespace_dns_mappings(text: str):
      """
      Expected format (repeated blocks):
        namespace: some-ns
        dns:
          - a.example.com
          - b.example.com
      """
      requests = []
      current_ns = None
      current_dns = []

      # Normalize lines (ignore empty lines)
      lines = [ln.rstrip() for ln in text.splitlines()]
      for ln in lines:
        if not ln.strip():
          continue

        # namespace line
        m = re.match(r"^\s*namespace\s*:\s*(.+?)\s*$", ln, re.IGNORECASE)
        if m:
          # flush previous block
          if current_ns:
            if not current_dns:
              raise ValueError(f"Namespace '{current_ns}' has no DNS entries.")
            requests.append({"namespace": current_ns, "dns_names": current_dns})
          current_ns = m.group(1).strip()
          current_dns = []
          continue

        # dns: line (just a marker)
        if re.match(r"^\s*dns\s*:\s*$", ln, re.IGNORECASE):
          continue

        # list item line: - value
        m = re.match(r"^\s*-\s*(.+?)\s*$", ln)
        if m:
          if not current_ns:
            raise ValueError("Found DNS entry before any namespace.")
          current_dns.append(m.group(1).strip())
          continue

        # Anything else is invalid for this format
        raise ValueError(f"Unrecognized line: '{ln}'")

      # flush last block
      if current_ns:
        if not current_dns:
          raise ValueError(f"Namespace '{current_ns}' has no DNS entries.")
        requests.append({"namespace": current_ns, "dns_names": current_dns})

      return requests

    missing = []
    if not request_id:
      missing.append("Request Number")
    if not environment:
      missing.append("Environment Name")
    if not mappings_raw:
      missing.append("Namespace and DNS Names")

    if missing:
      print(f"ERROR: Missing required fields: {', '.join(missing)}")
      sys.exit(1)

    try:
      requests = parse_namespace_dns_mappings(mappings_raw)
    except Exception as e:
      print(f"ERROR: Failed to parse 'Namespace and DNS Names': {e}")
      sys.exit(1)

    payload = {
      "repo_name": event.get("repository", {}).get("full_name"),
      "requests": requests,
    }

    payload_json = json.dumps(payload)

    with open(os.environ["GITHUB_OUTPUT"], "a") as output:
      output.write(f"request_id={request_id}\n")
      output.write(f"environment={environment}\n")
      output.write("request_payload<<EOF\n")
      output.write(payload_json + "\n")
      output.write("EOF\n")
    PY
